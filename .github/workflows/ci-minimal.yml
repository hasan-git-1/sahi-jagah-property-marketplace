name: Minimal CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'

jobs:
  # Simple health check
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check backend files
        run: |
          echo "Checking backend files..."
          ls -la backend/
          echo "Backend index-minimal.js exists: $(test -f backend/index-minimal.js && echo 'YES' || echo 'NO')"
          echo "Backend vercel.json exists: $(test -f backend/vercel.json && echo 'YES' || echo 'NO')"

      - name: Validate vercel.json
        run: |
          echo "Validating vercel.json..."
          cd backend
          node -e "console.log('vercel.json is valid JSON:', JSON.parse(require('fs').readFileSync('vercel.json', 'utf8')))"

  # Test minimal backend locally
  test-minimal-backend:
    name: Test Minimal Backend
    runs-on: ubuntu-latest
    needs: [health-check]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Test minimal backend
        run: |
          cd backend
          echo "Starting minimal backend test..."
          timeout 10s node index-minimal.js &
          sleep 3
          echo "Testing health endpoint..."
          curl -f http://localhost:3000/health || echo "Health check failed"
          echo "Testing API health endpoint..."
          curl -f http://localhost:3000/api/v1/health || echo "API health check failed"
          echo "Testing signup endpoint..."
          curl -f -X POST -H "Content-Type: application/json" -d '{"name":"Test","email":"test@test.com","role":"client"}' http://localhost:3000/api/v1/auth/signup || echo "Signup test failed"

  # Deploy notification
  deploy-notification:
    name: Deploy Notification
    runs-on: ubuntu-latest
    needs: [test-minimal-backend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Notify deployment
        run: |
          echo "ðŸš€ Minimal backend deployment triggered"
          echo "Vercel will automatically deploy the backend"
          echo "Check status at: https://vercel.com/dashboard"