<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Final Signup Test</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px; 
            border-left: 4px solid #007bff; 
        }
        .success { background: #d4edda; border-left-color: #28a745; }
        .error { background: #f8d7da; border-left-color: #dc3545; }
        .warning { background: #fff3cd; border-left-color: #ffc107; }
        .loading { background: #e2e3e5; border-left-color: #6c757d; }
        
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 16px;
            transition: background 0.2s;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 6px; 
            overflow-x: auto; 
            font-size: 14px;
            border: 1px solid #e9ecef;
        }
        
        .status-icon { font-size: 24px; margin-right: 10px; }
        .test-title { font-size: 18px; font-weight: 600; margin-bottom: 10px; }
        .test-description { color: #6c757d; margin-bottom: 15px; }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .final-result {
            text-align: center;
            padding: 30px;
            margin: 20px 0;
            border-radius: 10px;
            font-size: 20px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Final Signup Test - Sahi Jagah Property</h1>
        <p>This comprehensive test will verify that your signup functionality is working perfectly.</p>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
        
        <button onclick="runFullTest()" id="testButton">üöÄ Run Complete Test</button>
        <button onclick="clearResults()" id="clearButton">üßπ Clear Results</button>
        
        <div id="results"></div>
        <div id="finalResult"></div>
    </div>

    <script>
        const API_BASE = 'https://sahijagahproperty.vercel.app';
        let currentStep = 0;
        const totalSteps = 5;
        
        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }
        
        function addResult(title, description, content, type = 'loading') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                loading: 'üîÑ'
            };
            
            div.innerHTML = `
                <div class="test-title">
                    <span class="status-icon">${icons[type]}</span>
                    ${title}
                </div>
                <div class="test-description">${description}</div>
                <div>${content}</div>
            `;
            results.appendChild(div);
            return div;
        }
        
        function updateResult(element, content, type) {
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                loading: 'üîÑ'
            };
            
            element.className = `test-section ${type}`;
            const titleElement = element.querySelector('.test-title .status-icon');
            if (titleElement) {
                titleElement.textContent = icons[type];
            }
            const contentElement = element.querySelector('div:last-child');
            if (contentElement) {
                contentElement.innerHTML = content;
            }
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('finalResult').innerHTML = '';
            currentStep = 0;
            updateProgress();
        }
        
        async function testEndpoint(url, options = {}) {
            try {
                const response = await fetch(url, {
                    method: options.method || 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    body: options.body ? JSON.stringify(options.body) : undefined
                });
                
                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    data = await response.text();
                }
                
                return {
                    status: response.status,
                    statusText: response.statusText,
                    data: data,
                    headers: Object.fromEntries(response.headers.entries())
                };
            } catch (error) {
                return {
                    error: error.message,
                    type: 'network_error'
                };
            }
        }
        
        async function test1_BackendHealth() {
            const element = addResult(
                'Step 1: Backend Health Check',
                'Testing if your backend server is responding',
                'Connecting to backend...',
                'loading'
            );
            
            const result = await testEndpoint(`${API_BASE}/health`);
            currentStep++;
            updateProgress();
            
            if (result.error) {
                updateResult(element, `
                    <strong>‚ùå Backend is DOWN</strong><br>
                    <strong>Error:</strong> ${result.error}<br>
                    <strong>This means:</strong> Your Vercel backend is not responding.<br>
                    <strong>Action needed:</strong> Check Vercel deployment status.
                `, 'error');
                return false;
            } else if (result.status === 200) {
                updateResult(element, `
                    <strong>‚úÖ Backend is ONLINE</strong><br>
                    <strong>Status:</strong> ${result.status} ${result.statusText}<br>
                    <strong>Response:</strong><br>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                `, 'success');
                return true;
            } else {
                updateResult(element, `
                    <strong>‚ö†Ô∏è Unexpected Response</strong><br>
                    <strong>Status:</strong> ${result.status} ${result.statusText}<br>
                    <strong>Response:</strong><br>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                `, 'warning');
                return false;
            }
        }
        
        async function test2_APIHealth() {
            const element = addResult(
                'Step 2: API Health Check',
                'Testing if your API endpoints are working',
                'Testing API health...',
                'loading'
            );
            
            const result = await testEndpoint(`${API_BASE}/api/v1/health`);
            currentStep++;
            updateProgress();
            
            if (result.error) {
                updateResult(element, `
                    <strong>‚ùå API Routes Not Working</strong><br>
                    <strong>Error:</strong> ${result.error}<br>
                    <strong>This means:</strong> Backend is up but API routes are broken.
                `, 'error');
                return false;
            } else if (result.status === 200) {
                updateResult(element, `
                    <strong>‚úÖ API Routes Working</strong><br>
                    <strong>Status:</strong> ${result.status}<br>
                    <strong>Response:</strong><br>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                `, 'success');
                return true;
            } else {
                updateResult(element, `
                    <strong>‚ö†Ô∏è API Issue</strong><br>
                    <strong>Status:</strong> ${result.status}<br>
                    <strong>Response:</strong><br>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                `, 'warning');
                return false;
            }
        }
        
        async function test3_CORSCheck() {
            const element = addResult(
                'Step 3: CORS Configuration',
                'Testing if your frontend can communicate with backend',
                'Checking CORS headers...',
                'loading'
            );
            
            const result = await testEndpoint(`${API_BASE}/api/v1/health`);
            currentStep++;
            updateProgress();
            
            if (result.error) {
                updateResult(element, `
                    <strong>‚ùå CORS Issue</strong><br>
                    <strong>Error:</strong> ${result.error}<br>
                    <strong>This means:</strong> Backend doesn't allow requests from your domain.<br>
                    <strong>Fix needed:</strong> Update CORS configuration in backend.
                `, 'error');
                return false;
            } else {
                const corsHeaders = {
                    'access-control-allow-origin': result.headers['access-control-allow-origin'],
                    'access-control-allow-methods': result.headers['access-control-allow-methods'],
                    'access-control-allow-headers': result.headers['access-control-allow-headers']
                };
                
                const hasCORS = corsHeaders['access-control-allow-origin'];
                
                updateResult(element, `
                    <strong>${hasCORS ? '‚úÖ CORS Configured' : '‚ö†Ô∏è CORS Missing'}</strong><br>
                    <strong>Your Origin:</strong> ${window.location.origin}<br>
                    <strong>CORS Headers:</strong><br>
                    <pre>${JSON.stringify(corsHeaders, null, 2)}</pre>
                `, hasCORS ? 'success' : 'warning');
                return true;
            }
        }
        
        async function test4_SignupEndpoint() {
            const element = addResult(
                'Step 4: Signup Functionality',
                'Testing the actual signup process with sample data',
                'Testing signup with sample user...',
                'loading'
            );
            
            const testData = {
                name: 'Test User ' + Date.now(),
                email: 'test' + Date.now() + '@example.com',
                password: 'testpassword123',
                role: 'client'
            };
            
            const result = await testEndpoint(`${API_BASE}/api/v1/auth/signup`, {
                method: 'POST',
                body: testData
            });
            
            currentStep++;
            updateProgress();
            
            if (result.error) {
                updateResult(element, `
                    <strong>‚ùå Signup Failed - Network Error</strong><br>
                    <strong>Error:</strong> ${result.error}<br>
                    <strong>This means:</strong> Cannot reach signup endpoint.<br>
                    <strong>Likely cause:</strong> CORS or network issues.
                `, 'error');
                return false;
            } else if (result.status === 201 || result.status === 200) {
                updateResult(element, `
                    <strong>‚úÖ Signup Working Perfectly!</strong><br>
                    <strong>Status:</strong> ${result.status} ${result.statusText}<br>
                    <strong>Test Data:</strong><br>
                    <pre>${JSON.stringify(testData, null, 2)}</pre>
                    <strong>Response:</strong><br>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                `, 'success');
                return true;
            } else if (result.status === 409) {
                updateResult(element, `
                    <strong>‚úÖ Signup Endpoint Working (User Exists)</strong><br>
                    <strong>Status:</strong> ${result.status} - User already exists<br>
                    <strong>This is good:</strong> The endpoint is working, just user already exists.<br>
                    <strong>Response:</strong><br>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                `, 'success');
                return true;
            } else {
                updateResult(element, `
                    <strong>‚ùå Signup Error</strong><br>
                    <strong>Status:</strong> ${result.status} ${result.statusText}<br>
                    <strong>Response:</strong><br>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre>
                    <strong>Possible issues:</strong><br>
                    ‚Ä¢ Firebase configuration problems<br>
                    ‚Ä¢ Missing environment variables<br>
                    ‚Ä¢ Database connection issues
                `, 'error');
                return false;
            }
        }
        
        async function test5_EnvironmentCheck() {
            const element = addResult(
                'Step 5: Environment Configuration',
                'Checking your deployment environment settings',
                'Analyzing configuration...',
                'loading'
            );
            
            currentStep++;
            updateProgress();
            
            const envInfo = {
                'Current Domain': window.location.origin,
                'Expected API URL': API_BASE,
                'Browser': navigator.userAgent.split(' ')[0],
                'Test Time': new Date().toISOString()
            };
            
            updateResult(element, `
                <strong>‚ÑπÔ∏è Environment Information</strong><br>
                <pre>${JSON.stringify(envInfo, null, 2)}</pre>
                <strong>Checklist for Netlify:</strong><br>
                ‚Ä¢ VITE_API_URL = ${API_BASE}/api/v1<br>
                ‚Ä¢ All VITE_FIREBASE_* variables set<br>
                ‚Ä¢ Site deployed from main branch<br><br>
                <strong>Checklist for Vercel:</strong><br>
                ‚Ä¢ FIREBASE_SERVICE_ACCOUNT_KEY (full JSON)<br>
                ‚Ä¢ FIREBASE_DATABASE_URL<br>
                ‚Ä¢ JWT_SECRET<br>
                ‚Ä¢ All other environment variables
            `, 'loading');
            
            return true;
        }
        
        async function runFullTest() {
            clearResults();
            
            const testButton = document.getElementById('testButton');
            testButton.disabled = true;
            testButton.textContent = 'üîÑ Testing...';
            
            let allPassed = true;
            
            try {
                // Run all tests
                const test1Result = await test1_BackendHealth();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const test2Result = await test2_APIHealth();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const test3Result = await test3_CORSCheck();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const test4Result = await test4_SignupEndpoint();
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const test5Result = await test5_EnvironmentCheck();
                
                // Determine overall result
                allPassed = test1Result && test2Result && test3Result && test4Result;
                
                // Show final result
                const finalResult = document.getElementById('finalResult');
                if (allPassed) {
                    finalResult.innerHTML = `
                        <div class="final-result success">
                            üéâ <strong>ALL TESTS PASSED!</strong><br>
                            Your signup functionality is working perfectly!<br>
                            <br>
                            <strong>‚úÖ What this means:</strong><br>
                            ‚Ä¢ Backend is deployed and running<br>
                            ‚Ä¢ API endpoints are working<br>
                            ‚Ä¢ CORS is configured correctly<br>
                            ‚Ä¢ Signup process is functional<br>
                            <br>
                            <strong>üöÄ You can now:</strong><br>
                            ‚Ä¢ Go to your live site and test signup<br>
                            ‚Ä¢ Users can create accounts successfully<br>
                            ‚Ä¢ All authentication features should work<br>
                        </div>
                    `;
                } else {
                    finalResult.innerHTML = `
                        <div class="final-result error">
                            ‚ùå <strong>SOME TESTS FAILED</strong><br>
                            Your signup is not working yet.<br>
                            <br>
                            <strong>üìã Next Steps:</strong><br>
                            1. Check the failed tests above<br>
                            2. Follow the specific error messages<br>
                            3. Fix the issues mentioned<br>
                            4. Run the test again<br>
                            <br>
                            <strong>üÜò Common Fixes:</strong><br>
                            ‚Ä¢ Wait 2-3 minutes for deployment<br>
                            ‚Ä¢ Check Vercel environment variables<br>
                            ‚Ä¢ Verify Firebase configuration<br>
                            ‚Ä¢ Check Vercel function logs for errors<br>
                        </div>
                    `;
                }
                
            } catch (error) {
                const finalResult = document.getElementById('finalResult');
                finalResult.innerHTML = `
                    <div class="final-result error">
                        ‚ùå <strong>TEST ERROR</strong><br>
                        Something went wrong during testing.<br>
                        Error: ${error.message}
                    </div>
                `;
            } finally {
                testButton.disabled = false;
                testButton.textContent = 'üöÄ Run Complete Test';
            }
        }
    </script>
</body>
</html>